# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª –ø–æ—Å–ª–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª –±–æ—Ç –∏–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–ª —Ç–µ–∫—Å—Ç–æ–º –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª: `ConversationHandler` –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∞ `check_action_message` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª –ª—é–±–æ–π —Ç–µ–∫—Å—Ç (–≤ —Ç.—á. —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ ¬´–û–ø—Ä–æ—Å¬ª).

## –†–µ—à–µ–Ω–∏–µ

### 1. –ï–¥–∏–Ω—ã–π Regex –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é

- –í `handlers/common.py`: –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `MENU_BUTTONS_REGEX` ‚Äî –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é, **–≤–∫–ª—é—á–∞—è ¬´üìù –û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª**.
- –í `main.py` –¥–ª—è `menu_button_handler` –∏ –¥–ª—è fallback –≤ ConversationHandler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ Regex.
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º ¬´üìù –û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª —Ç–µ–ø–µ—Ä—å –ª–∏–±–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è `survey_conv` (entry point), –ª–∏–±–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `menu_button_handler`, –Ω–æ **–Ω–µ** –≤ `check_action_message`.

### 2. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –º–µ–Ω—é

- **`conversation_reset(update, context, reason)`** –≤ `handlers/common.py`: –æ—á–∏—â–∞–µ—Ç `context.user_data` –∏ –ø–∏—à–µ—Ç –ª–æ–≥ `conversation_reset user_id=... reason=...`.
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏:
  - **/start** ‚Äî –≤ –Ω–∞—á–∞–ª–µ `start_command`;
  - **/menu** ‚Äî –≤ –Ω–∞—á–∞–ª–µ `menu_command`;
  - **¬´üìù –û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª** ‚Äî –≤ –Ω–∞—á–∞–ª–µ `survey_start`;
  - **¬´üîÅ –†–µ–∂–∏–º: FREE/PRO¬ª** ‚Äî –≤ –Ω–∞—á–∞–ª–µ `mode_switch_command`;
  - **–ª—é–±–∞—è –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é** ‚Äî –≤ –Ω–∞—á–∞–ª–µ `menu_button_handler` (–¥–æ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –∫–æ–º–∞–Ω–¥–µ).

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç –æ–ø—Ä–æ—Å–∞) –æ—á–∏—â–∞—é—Ç—Å—è, –∞ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –Ω–∞–∂–∞—Ç–∏–∏ ¬´–û–ø—Ä–æ—Å¬ª –≤ `user_data` –Ω–µ—Ç ¬´—Ö–≤–æ—Å—Ç–æ–≤¬ª –æ—Ç check_action.

### 3. –†–∞–∑–¥–µ–ª—å–Ω—ã–µ ConversationHandler

- **conv_handler** (start/setdata): –¥–∞—Ç–∞ ‚Üí –≤—Ä–µ–º—è ‚Üí –º–µ—Å—Ç–æ; —Å–≤–æ–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ fallbacks.
- **survey_conv** (–æ–ø—Ä–æ—Å): –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –≤–æ–ø—Ä–æ—Å—ã; —Å–≤–æ–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ fallbacks.
- **check_action** ‚Äî **–Ω–µ** ConversationHandler: –æ–¥–∏–Ω –≤—ã–∑–æ–≤ `check_action_start` –∏ –æ–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π `MessageHandler(filters.TEXT, check_action_message)`. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ `context.user_data` (`check_action_step`, `action_draft`).

–û–Ω–∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è: —É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π –Ω–∞–±–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ handler‚Äô–æ–≤.

### 4. Fallback –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ª–æ–≥–∞

- –í **conv_handler** –∏ **survey_conv** –≤ `fallbacks` –¥–æ–±–∞–≤–ª–µ–Ω `MessageHandler(filters.Regex(MENU_BUTTONS_REGEX), ...)`.
- **conv_fallback_menu_button** (start.py): –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ª—é–±–æ–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –≤–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å–±—Ä–æ—Å, ¬´–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –∏–∑ –º–µ–Ω—é¬ª, `ConversationHandler.END`.
- **survey_fallback_menu_button** (survey.py): –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ª—é–±–æ–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –≤–æ –≤—Ä–µ–º—è –æ–ø—Ä–æ—Å–∞ ‚Äî —Å–±—Ä–æ—Å, –æ—Ç–º–µ–Ω–∞ run –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, ¬´–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –∏–∑ –º–µ–Ω—é¬ª, `ConversationHandler.END`.

–¢–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤—ã–π—Ç–∏ –∏–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏–ª–∏ –æ–ø—Ä–æ—Å–∞, –Ω–∞–∂–∞–≤ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é.

### 5. –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (main.py)

1. **conv_handler** ‚Äî –µ—Å–ª–∏ —á–∞—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ setdata, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ fallback –ø–æ –∫–Ω–æ–ø–∫–µ –º–µ–Ω—é).
2. **survey_conv** ‚Äî –µ—Å–ª–∏ —á–∞—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–ø—Ä–æ—Å–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ fallback –ø–æ –∫–Ω–æ–ø–∫–µ –º–µ–Ω—é); –∏–Ω–∞—á–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç entry points (–≤ —Ç.—á. ¬´üìù –û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª).
3. CommandHandler("menu"), ...
4. **MessageHandler(MENU_BUTTONS_REGEX, menu_button_handler)** ‚Äî –ª—é–±—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é (–≤ —Ç.—á. ¬´–û–ø—Ä–æ—Å¬ª) –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞.
5. **MessageHandler(TEXT, check_action_message)** ‚Äî –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç (–≤ —Ç.—á. –≤–≤–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª).

–°–æ–æ–±—â–µ–Ω–∏–µ ¬´üìù –û–ø—Ä–æ—Å (–±–æ–Ω—É—Å PRO)¬ª –ª–∏–±–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è survey_conv (entry point), –ª–∏–±–æ menu_button_handler (Regex), –Ω–æ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ check_action_message.

## –¢–µ—Å—Ç

1. –ù–∞–∂–∞—Ç—å ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª, –Ω–µ –≤–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç.
2. –ù–∞–∂–∞—Ç—å ¬´–û–ø—Ä–æ—Å¬ª ‚Üí –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –æ–ø—Ä–æ—Å (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ¬´–ù–∞—á–Ω—ë–º?¬ª), –∞ –Ω–µ —Å—Ü–µ–Ω–∞—Ä–∏–π ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª.
3. –ü–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞ –Ω–∞–∂–∞—Ç—å ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª ‚Üí —Å—Ü–µ–Ω–∞—Ä–∏–π ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ¬ª —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –õ–æ–≥

–ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–±—Ä–æ—Å–µ –≤ –ª–æ–≥–∞—Ö:

```
conversation_reset user_id=<telegram_id> reason=<start|menu|survey|mode_switch|menu_button|conv_fallback_menu_button|survey_fallback_menu_button>
```
