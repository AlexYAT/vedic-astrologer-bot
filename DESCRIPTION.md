# Полное описание программы «Ведический астролог»

Telegram-бот «Ведический астролог» — персональный советник по ведической астрологии (Джйотиш). Собирает данные рождения и контактную информацию пользователей, формирует персонализированные прогнозы через OpenAI Assistants API и отдаёт ответы в Telegram с форматированием.

---

## 1. Назначение

- **Цель:** дать пользователю персонализированные астрологические прогнозы в формате чата Telegram.
- **Роль бота:** сбор данных пользователя (дата, время, место рождения; опционально телефон и email), формирование запросов к AI-ассистенту и отображение ответов с учётом текущей даты и выбранного типа прогноза.

---

## 2. Функциональность

### 2.1. Регистрация и данные пользователя

- **Команда /start** — точка входа:
  - если данные рождения уже есть: приветствие с именем пользователя и главное меню;
  - если данных нет: пошаговый сбор даты (ДД.ММ.ГГГГ), времени (ЧЧ:ММ), места рождения, опционально телефона и email.
- **Команда /setdata или кнопка «Изменить данные»** — повторный ввод или изменение данных рождения (тот же сценарий, что при первом /start).
- **Команда /cancel** — отмена сценария ввода данных.
- Имя пользователя в приветствии определяется по данным Telegram: имя и фамилия, при отсутствии — username или «друг».

### 2.2. Прогнозы (требуют заполненных данных рождения)

- **Завтра** (кнопка или `/tomorrow`) — персонализированный прогноз на завтрашний день.
- **Темы** (кнопка или `/topics`) — инлайн-клавиатура с темами: Карьера, Отношения, Здоровье, Финансы, Духовность; после выбора — прогноз по выбранной теме.
- **Благоприятные дни** (кнопка или `/favorable`) — рекомендации ближайших благоприятных дней для важных начинаний.

### 2.3. Контакты

- **Контакты** (кнопка или `/contact`) — показ текущих телефона и email и ввод новых в формате «Телефон: …» и «Email: …» (можно указать один параметр или «пропустить»).

### 2.4. Интерфейс

- Главное меню — кнопки на русском: **Завтра**, **Темы**, **Благоприятные дни**, **Контакты**, **Изменить данные**.
- Темы прогноза — инлайн-кнопки на русском.
- Ответы ассистента отображаются с HTML-форматированием (жирные заголовки); заголовки Markdown (###, **) нормализуются перед отправкой в Telegram.

---

## 3. Технологии

| Компонент | Технология |
|-----------|------------|
| Язык | Python 3.10+ |
| Telegram | библиотека `python-telegram-bot` 20.x |
| AI | OpenAI Assistants API (клиент `openai`) |
| Конфигурация | `python-dotenv`, переменные в `.env` |
| База данных | SQLite 3 (файл `users.db`) |

Секреты (токен бота, API-ключ OpenAI, ID ассистента) задаются только через переменные окружения или `.env`, в коде не хранятся.

---

## 4. Архитектура

- **Точка входа:** `main.py` — загрузка конфигурации, инициализация БД и ассистента, регистрация обработчиков, запуск long polling.
- **Обработчики:** пакет `handlers` — команды и сценарии (start, commands, common).
- **Работа с AI:** модуль `assistant.py` — один тред на пользователя, добавление текущей даты к запросу, отправка в API, ожидание ответа.
- **Данные:** модуль `db.py` — SQLite, таблица `users` (user_id, дата/время/место рождения, телефон, email, thread_id, метки времени).
- **Конфигурация:** модуль `config.py` — чтение `.env`, доступ к токену, API-ключу, ID ассистента и пути к БД.

Все запросы к ассистенту проходят через одну функцию `assistant.send_message_and_get_response(user_id, message)`. Текст `message` формируется в `handlers/commands.py` в зависимости от действия (Завтра, Темы, Благоприятные дни). Подробнее — в [LOGIC.md](LOGIC.md).

---

## 5. Структура проекта

```
vedic_astrologer_bot/
├── .env.example          # Шаблон переменных окружения
├── .gitignore
├── requirements.txt      # Зависимости Python
├── README.md             # Краткая документация и запуск
├── LOGIC.md              # Логика формирования запросов к AI
├── DESCRIPTION.md        # Полное описание программы (этот файл)
├── config.py             # Загрузка .env, доступ к токену, ключу, ASSISTANT_ID, пути к БД
├── db.py                 # SQLite: инициализация, CRUD для users
├── assistant.py          # OpenAI Assistants API: треды, отправка сообщений, ожидание ответа
├── main.py               # Точка входа: инициализация, регистрация обработчиков, run_polling
├── setup.bat             # Скрипт настройки под Windows (venv, pip, git)
└── handlers/
    ├── __init__.py
    ├── start.py          # /start, сбор данных (дата, время, место, телефон, email), приветствие
    ├── commands.py       # Завтра, Темы, Благоприятные дни, Контакты, Изменить данные; вызов ассистента
    └── common.py         # Клавиатуры, валидация, имя пользователя, форматирование ответа для Telegram
```

После первого запуска в каталоге бота появляется файл `users.db` (если не задан другой путь в конфигурации).

---

## 6. Поток данных пользователя

1. Пользователь запускает бота (**/start**).
2. Бот создаёт запись в БД (если её ещё нет) и проверяет наличие даты, времени и места рождения.
3. Если данных нет — пошаговый сбор (дата → время → место → телефон → email), затем сохранение в БД.
4. Если данные есть — приветствие с именем и главное меню (кнопки на русском).
5. При выборе «Завтра», «Темы» или «Благоприятные дни» бот проверяет полноту данных; при отсутствии — просит /start или «Изменить данные».
6. При наличии данных: из БД читаются дата/время/место рождения; формируется текст запроса к ассистенту; в `assistant.py` к нему добавляется «Сегодня ДД.ММ.ГГГГ»; сообщение отправляется в тред пользователя в OpenAI; ответ обрабатывается (форматирование заголовков в HTML) и отправляется пользователю в Telegram.
7. Контакты (телефон, email) хранятся в той же таблице `users` и могут быть обновлены через «Контакты» (/contact).

---

## 7. База данных (SQLite)

**Таблица `users`:**

| Поле | Тип | Описание |
|------|-----|----------|
| user_id | INTEGER | ID пользователя Telegram (PRIMARY KEY) |
| birth_date | TEXT | Дата рождения (ДД.ММ.ГГГГ) |
| birth_time | TEXT | Время рождения (ЧЧ:ММ) |
| birth_place | TEXT | Место рождения |
| phone | TEXT | Телефон (опционально) |
| email | TEXT | Email (опционально) |
| thread_id | TEXT | ID треда OpenAI для этого пользователя |
| created_at | TIMESTAMP | Время создания записи |
| updated_at | TIMESTAMP | Время последнего обновления |

Файл БД по умолчанию: `users.db` в каталоге бота (задаётся в `config.get_db_path()`).

---

## 8. Конфигурация и запуск

### 8.1. Переменные окружения (.env)

- **TELEGRAM_BOT_TOKEN** — токен бота (получить у [@BotFather](https://t.me/BotFather)).
- **OPENAI_API_KEY** — API-ключ OpenAI ([platform.openai.com](https://platform.openai.com)).
- **ASSISTANT_ID** — ID ассистента OpenAI (вид `asst_xxxx...`, создаётся в разделе Assistants).

Файл `.env` создаётся на основе `.env.example` и в репозиторий не попадает (указан в `.gitignore`).

### 8.2. Запуск

1. Установить зависимости: `pip install -r requirements.txt`.
2. Создать и заполнить `.env`.
3. Запустить: `python main.py`.

Подробная установка и создание ассистента OpenAI — в [README.md](README.md).

---

## 9. Модули и их роли

| Модуль | Назначение |
|--------|------------|
| **main.py** | Инициализация конфига, БД и ассистента; регистрация ConversationHandler (start/setdata/сбор данных), команд (/tomorrow, /topics, /favorable, /contact), обработчика кнопок меню, обработчика контактов, callback для тем; запуск polling. |
| **config.py** | Загрузка `.env`, функции: `get_telegram_token()`, `get_openai_api_key()`, `get_assistant_id()`, `get_db_path()`. |
| **db.py** | `init_db()`, `get_connection()`, `user_exists()`, `user_has_full_data()`, `get_user()`, `create_user()`, `update_user()`, `save_user_data()`. |
| **assistant.py** | `init_assistant()`, `get_or_create_thread()`, `send_message_and_get_response()` (добавление текущей даты, отправка в тред, ожидание Run, чтение ответа). |
| **handlers/start.py** | Обработка /start, пошаговый сбор данных (дата, время, место, телефон, email), приветствие с именем, отмена (/cancel). |
| **handlers/commands.py** | Формирование текста запроса к AI, вызов ассистента, форматирование ответа; обработчики: Завтра, Темы (и callback по теме), Благоприятные дни, Контакты, Изменить данные; обработчик нажатий кнопок меню. |
| **handlers/common.py** | Клавиатуры (главное меню на русском, темы), валидация (дата, время, email), `get_user_display_name()`, `format_assistant_response_for_telegram()` (нормализация заголовков и перевод в HTML). |

---

## 10. Связанные документы

- **README.md** — установка, настройка, команды, структура каталогов.
- **LOGIC.md** — детальное описание формирования запросов к AI, шаблоны сообщений, цепочка от кнопки до ответа в Telegram.
