# Логика формирования запросов к AI

Описание того, как бот «Ведический астролог» формирует запросы к OpenAI Assistants API и обрабатывает ответы.

---

## 1. Общая схема

Все запросы к ассистенту проходят через одну функцию **`assistant.send_message_and_get_response(user_id, message)`**. Текст `message` собирается в **handlers/commands.py** в зависимости от действия пользователя (Завтра, Темы, Благоприятные дни). Перед отправкой в API к сообщению добавляется текущая дата.

---

## 2. Где формируется текст запроса

| Действие пользователя | Обработчик | Содержимое запроса |
|-----------------------|------------|---------------------|
| **Завтра** (кнопка или `/tomorrow`) | `tomorrow_command` | Данные пользователя + инструкция «Сделай персонализированный прогноз на завтрашний день для этого человека.» |
| **Темы** → выбор темы (Карьера, Отношения и т.д.) | `topic_callback` | Данные пользователя + инструкция «Дай персонализированный прогноз по теме «{название темы}» для этого человека.» |
| **Благоприятные дни** (кнопка или `/favorable`) | `favorable_command` | Данные пользователя + инструкция «Рекомендуй ближайшие благоприятные дни для важных начинаний с учётом его гороскопа.» |

Во всех случаях перед формированием запроса проверяется наличие данных рождения: **дата, время и место** (`db.user_has_full_data(user.id)`). Если данных нет, пользователю показывается сообщение с просьбой отправить `/start` или «Изменить данные», запрос к AI не выполняется.

---

## 3. Данные пользователя в запросе

Функция **`format_user_data_for_prompt(user)`** в `handlers/commands.py` формирует строку:

```
Дата рождения: ДД.ММ.ГГГГ
Время рождения: ЧЧ:ММ
Место рождения: город, страна
```

Значения берутся из БД (SQLite) по `user_id`. Эта строка подставляется в начало каждого запроса к ассистенту в виде блока «Данные пользователя:» + три строки выше.

---

## 4. Шаблоны сообщений для AI

### Завтра (прогноз на завтрашний день)

```
Данные пользователя:
Дата рождения: ...
Время рождения: ...
Место рождения: ...

Сделай персонализированный прогноз на завтрашний день для этого человека.
```

### Темы (прогноз по выбранной теме)

Темы: **Карьера**, **Отношения**, **Здоровье**, **Финансы**, **Духовность**.

```
Данные пользователя:
...

Дай персонализированный прогноз по теме «{название темы}» для этого человека.
```

### Благоприятные дни

```
Данные пользователя:
...

Рекомендуй ближайшие благоприятные дни для важных начинаний с учётом его гороскопа.
```

---

## 5. Добавление текущей даты (assistant.py)

Перед отправкой сообщения в тред OpenAI в **`send_message_and_get_response`** к тексту запроса добавляется текущая дата:

```python
today = datetime.now().strftime("%d.%m.%Y")
enhanced_message = f"Сегодня {today}. {message}"
```

В тред уходит **`enhanced_message`**, а не исходный `message`. Так модель знает актуальную дату (год и месяц), и прогнозы строятся от «сегодня» (например, 2026), а не от устаревшей даты.

---

## 6. Полная цепочка запроса

1. **Пользователь** нажимает кнопку (Завтра, Темы, Благоприятные дни) или вводит команду (`/tomorrow`, `/topics`, `/favorable`).
2. **Проверка данных:** `db.user_has_full_data(user.id)`. Если нет — ответ без вызова AI.
3. **Загрузка данных из БД** → `format_user_data_for_prompt(user_data)` → строка `data_str`.
4. **Формирование сообщения** `message`: блок «Данные пользователя» + инструкция по типу запроса.
5. **Вызов** `assistant.send_message_and_get_response(user.id, message)`:
   - получение или создание треда для пользователя (`get_or_create_thread`);
   - добавление префикса «Сегодня ДД.ММ.ГГГГ.» к `message` → `enhanced_message`;
   - добавление в тред сообщения с ролью `user` и текстом `enhanced_message`;
   - создание Run и ожидание статуса `completed`;
   - чтение последнего сообщения ассистента и извлечение текста ответа.
6. **Постобработка ответа:** `format_assistant_response_for_telegram(response)` — нормализация заголовков (###, **) и перевод в HTML для Telegram.
7. **Отправка пользователю** с `parse_mode="HTML"`.

---

## 7. Треды и контекст

- У каждого пользователя один **thread_id** (хранится в БД в поле `thread_id`).
- История диалога с ассистентом сохраняется в этом треде на стороне OpenAI.
- Один и тот же ассистент (`ASSISTANT_ID` из `.env`) обрабатывает все запросы.
- В коде бота история сообщений не хранится — только идентификатор треда и данные пользователя из БД.

---

## 8. Файлы, участвующие в логике

| Файл | Роль |
|------|------|
| **handlers/commands.py** | Формирование текста запроса (`format_user_data_for_prompt`, шаблоны в `tomorrow_command`, `topic_callback`, `favorable_command`), вызов ассистента, форматирование ответа для Telegram. |
| **assistant.py** | Добавление текущей даты к сообщению, работа с тредом, отправка в API, ожидание и чтение ответа. |
| **db.py** | Чтение данных пользователя (дата/время/место рождения, `thread_id`) и проверка полноты данных. |
| **handlers/common.py** | `format_assistant_response_for_telegram()` — преобразование ответа ассистента в HTML для отображения в Telegram. |
